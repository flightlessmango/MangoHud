name: Ubuntu build testing

on: [push, pull_request]

jobs:
  build-test:
    strategy:
      matrix:
        compiler: [clang, gcc]
        os: [ubuntu-24.04]
    runs-on: ${{ matrix.os }}
    steps:
    - name: 'Checkout'
      uses: actions/checkout@v3
    - name: 'Install prerequisites'
      run: |
        sudo apt-get update
          source ./build_deps.sh
          DEPS_NO_I386="$(printf '%s' "$DEPS_DEBIAN" \
              | tr ',' '\n' \
              | grep -v ':i386' \
              | tr '\n' ' ')"
          sudo apt -o Acquire::Queue-Mode=access -y install $DEPS_NO_I386
    - name: 'Install clang'
      if:  ${{ (matrix.compiler == 'clang') }}
      run: |
          sudo apt-get install -y clang
          echo "CC=clang" >> "$GITHUB_ENV"
          echo "CXX=clang++" >> "$GITHUB_ENV"
    - name: 'Install gcc'
      if:  ${{ (matrix.compiler == 'gcc') }}
      run: |
          sudo apt-get install -y gcc g++
          echo "CC=gcc" >> "$GITHUB_ENV"
          echo "CXX=g++" >> "$GITHUB_ENV"
    - name: 'Configure'
      run: meson setup ./builddir --prefix=/usr
          -D include_doc=true
          -D with_xnvctrl=enabled
          -D with_x11=enabled
          -D with_wayland=enabled
          -D with_dbus=enabled
          -D mangoapp=true
          -D mangohudctl=true
          -D tests=enabled
          --werror
    - name: 'Build'
      run: meson compile -C ./builddir || ninja -C ./builddir
    - name: 'Install'
      run: sudo meson install -C ./builddir
